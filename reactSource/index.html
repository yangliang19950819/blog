<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>react17源码之useState | 有个网站</title><meta name="author" content="囧"><meta name="copyright" content="囧"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="react&#x2F;ReactHook.js useState 函数 useState 调用 resolveDispatcher 函数 dispatcher &#x3D; ReactCurrentDispatcher.current。  1234567891011121314151617181920212223242526export function useState&lt;S&gt;(  i">
<meta property="og:type" content="article">
<meta property="og:title" content="react17源码之useState">
<meta property="og:url" content="https://yangliang19950819.github.io/blog/reactSource/index.html">
<meta property="og:site_name" content="有个网站">
<meta property="og:description" content="react&#x2F;ReactHook.js useState 函数 useState 调用 resolveDispatcher 函数 dispatcher &#x3D; ReactCurrentDispatcher.current。  1234567891011121314151617181920212223242526export function useState&lt;S&gt;(  i">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yangliang19950819.github.io/blog/img/react-s.webp">
<meta property="article:published_time" content="2021-09-22T14:02:54.298Z">
<meta property="article:modified_time" content="2025-05-21T08:40:55.282Z">
<meta property="article:author" content="囧">
<meta property="article:tag" content="囧的博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yangliang19950819.github.io/blog/img/react-s.webp"><link rel="shortcut icon" href="../img/favicon.ico"><link rel="canonical" href="https://yangliang19950819.github.io/blog/reactSource/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="../css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'react17源码之useState',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2025-05-21 16:40:55'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="archives/"><div class="headline">文章</div><div class="length-num">17</div></a><a href="tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="index.html"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('../img/react-s.webp')"><nav id="nav"><span id="blog-info"><a href="index.html" title="有个网站"><span class="site-name">有个网站</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="index.html"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">react17源码之useState</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-09-22T14:02:54.298Z" title="发表于 2021-09-22 22:02:54">2021-09-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-05-21T08:40:55.282Z" title="更新于 2025-05-21 16:40:55">2025-05-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="react17源码之useState"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="react-ReactHook-js-useState-函数"><a href="#react-ReactHook-js-useState-函数" class="headerlink" title="react&#x2F;ReactHook.js useState 函数"></a>react&#x2F;ReactHook.js useState 函数</h3><ul>
<li>useState 调用 resolveDispatcher 函数 dispatcher &#x3D; ReactCurrentDispatcher.current。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> useState&lt;S&gt;(</span><br><span class="line">  <span class="attr">initialState</span>: (<span class="function">() =&gt;</span> S) | S</span><br><span class="line">): [S, <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt;] &#123;</span><br><span class="line">  <span class="keyword">const</span> dispatcher = <span class="title function_">resolveDispatcher</span>();</span><br><span class="line">  <span class="keyword">return</span> dispatcher.<span class="title function_">useState</span>(initialState);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolveDispatcher</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dispatcher = <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span>;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (dispatcher === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(</span><br><span class="line">        <span class="string">&quot;Invalid hook call. Hooks can only be called inside of the body of a function component. This could happen for&quot;</span> +</span><br><span class="line">          <span class="string">&quot; one of the following reasons:\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;1. You might have mismatching versions of React and the renderer (such as React DOM)\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;2. You might be breaking the Rules of Hooks\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;3. You might have more than one copy of React in the same app\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;See https://reactjs.org/link/invalid-hook-call for tips about how to debug and fix this problem.&quot;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Will result in a null access error if accessed outside render phase. We</span></span><br><span class="line">  <span class="comment">// intentionally don&#x27;t throw our own error because this is in a hot path.</span></span><br><span class="line">  <span class="comment">// Also helps ensure this is inlined.</span></span><br><span class="line">  <span class="keyword">return</span> ((<span class="attr">dispatcher</span>: any): <span class="title class_">Dispatcher</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ReactFiberHooks-old-js-在不同的阶段对应的-ReactCurrentDispatcher-current-值不一样"><a href="#ReactFiberHooks-old-js-在不同的阶段对应的-ReactCurrentDispatcher-current-值不一样" class="headerlink" title="ReactFiberHooks.old.js 在不同的阶段对应的 ReactCurrentDispatcher.current 值不一样"></a>ReactFiberHooks.old.js 在不同的阶段对应的 ReactCurrentDispatcher.current 值不一样</h3><ul>
<li>react 在不同的阶段对应的 ReactCurrentDispatcher.current 值不一样，主要为 mount 阶段为 InvalidNestedHooksDispatcherOnMountInDEV，<br>更新阶段为 HooksDispatcherOnUpdateInDEV，渲染阶段 HooksDispatcherOnRerenderInDEV。这三个对象里面含有 react 的 hooks 的所有方法。</li>
</ul>
<figure class="highlight js"><figcaption><span>dispatcher</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">InvalidNestedHooksDispatcherOnMountInDEV</span>：&#123;</span><br><span class="line">  ...</span><br><span class="line">  useState&lt;S&gt;(</span><br><span class="line">      <span class="attr">initialState</span>: (<span class="function">() =&gt;</span> S) | S,</span><br><span class="line">    ): [S, <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt;] &#123;</span><br><span class="line">      currentHookNameInDev = <span class="string">&#x27;useState&#x27;</span>;</span><br><span class="line">      <span class="title function_">warnInvalidHookAccess</span>();</span><br><span class="line">      <span class="title function_">mountHookTypesDev</span>();</span><br><span class="line">      <span class="keyword">const</span> prevDispatcher = <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span>;</span><br><span class="line">      <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span> = <span class="title class_">InvalidNestedHooksDispatcherOnMountInDEV</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">mountState</span>(initialState);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span> = prevDispatcher;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">HooksDispatcherOnUpdateInDEV</span>：&#123;</span><br><span class="line">  ...</span><br><span class="line">  useState&lt;S&gt;(</span><br><span class="line">      <span class="attr">initialState</span>: (<span class="function">() =&gt;</span> S) | S,</span><br><span class="line">    ): [S, <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt;] &#123;</span><br><span class="line">      currentHookNameInDev = <span class="string">&#x27;useState&#x27;</span>;</span><br><span class="line">      <span class="title function_">updateHookTypesDev</span>();</span><br><span class="line">      <span class="keyword">const</span> prevDispatcher = <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span>;</span><br><span class="line">      <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span> = <span class="title class_">InvalidNestedHooksDispatcherOnUpdateInDEV</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">updateState</span>(initialState);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span> = prevDispatcher;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">HooksDispatcherOnRerenderInDEV</span>：&#123;</span><br><span class="line">  ...</span><br><span class="line">  useState&lt;S&gt;(</span><br><span class="line">      <span class="attr">initialState</span>: (<span class="function">() =&gt;</span> S) | S,</span><br><span class="line">    ): [S, <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt;] &#123;</span><br><span class="line">      currentHookNameInDev = <span class="string">&#x27;useState&#x27;</span>;</span><br><span class="line">      <span class="title function_">updateHookTypesDev</span>();</span><br><span class="line">      <span class="keyword">const</span> prevDispatcher = <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span>;</span><br><span class="line">      <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span> = <span class="title class_">InvalidNestedHooksDispatcherOnRerenderInDEV</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">rerenderState</span>(initialState);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span> = prevDispatcher;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mountState-函数"><a href="#mountState-函数" class="headerlink" title="mountState 函数"></a>mountState 函数</h3><ul>
<li>mount 情况下，mountState 函数会调用 mountWorkInProgressHook 函数对 WorkInProgressHook 进行赋值，调用 dispatchAction 函数返回一个 dispatch 函数暴露给用户修改 state 值。</li>
</ul>
<figure class="highlight js"><figcaption><span>mountState</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> mountState&lt;S&gt;(</span><br><span class="line">  <span class="attr">initialState</span>: (<span class="function">() =&gt;</span> S) | S</span><br><span class="line">): [S, <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt;] &#123;</span><br><span class="line">  <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// $FlowFixMe: Flow doesn&#x27;t like mixed types</span></span><br><span class="line">    initialState = <span class="title function_">initialState</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  hook.<span class="property">memoizedState</span> = hook.<span class="property">baseState</span> = initialState;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">queue</span>: <span class="title class_">UpdateQueue</span>&lt;S, <span class="title class_">BasicStateAction</span>&lt;S&gt;&gt; = &#123;</span><br><span class="line">    <span class="attr">pending</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">interleaved</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">lanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">    <span class="attr">dispatch</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">lastRenderedReducer</span>: basicStateReducer,</span><br><span class="line">    <span class="attr">lastRenderedState</span>: (<span class="attr">initialState</span>: any),</span><br><span class="line">  &#125;;</span><br><span class="line">  hook.<span class="property">queue</span> = queue;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">dispatch</span>: <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt; = (queue.<span class="property">dispatch</span> =</span><br><span class="line">    (dispatchAction.<span class="title function_">bind</span>(<span class="literal">null</span>, currentlyRenderingFiber, queue): any));</span><br><span class="line">  <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="mountWorkInProgressHook-函数"><a href="#mountWorkInProgressHook-函数" class="headerlink" title="mountWorkInProgressHook 函数"></a>mountWorkInProgressHook 函数</h3><ul>
<li>mountWorkInProgressHook 函数会判断 workInProgressHook 是否等于 null,不是的话说明是新的 hook,会将当前 hook 加到之前 workInProgressHook.next 上并重写当前 workInProgressHook 并返回。</li>
</ul>
<figure class="highlight js"><figcaption><span>mountWorkInProgressHook</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountWorkInProgressHook</span>(<span class="params"></span>): <span class="title class_">Hook</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">hook</span>: <span class="title class_">Hook</span> = &#123;</span><br><span class="line">    <span class="attr">memoizedState</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">baseState</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">baseQueue</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">queue</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This is the first hook in the list</span></span><br><span class="line">    currentlyRenderingFiber.<span class="property">memoizedState</span> = workInProgressHook = hook;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Append to the end of the list</span></span><br><span class="line">    workInProgressHook = workInProgressHook.<span class="property">next</span> = hook;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dispatchAction-函数"><a href="#dispatchAction-函数" class="headerlink" title="dispatchAction 函数"></a>dispatchAction 函数</h3><ul>
<li>dispatchAction 方法会调用 requestEventTime 获取事件的时间,requestUpdateLane 方法获取当前的 fiber 的 lane，最后走到调度任务函数 scheduleUpdateOnFiber 进入调度阶段之后再到 Reconcile 阶段最后到 commit 阶段再更新视图。</li>
</ul>
<figure class="highlight js"><figcaption><span>dispatchAction</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> dispatchAction&lt;S, A&gt;(</span><br><span class="line">  <span class="attr">fiber</span>: <span class="title class_">Fiber</span>,</span><br><span class="line">  <span class="attr">queue</span>: <span class="title class_">UpdateQueue</span>&lt;S, A&gt;,</span><br><span class="line">  <span class="attr">action</span>: A</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">arguments</span>[<span class="number">3</span>] === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(</span><br><span class="line">        <span class="string">&quot;State updates from the useState() and useReducer() Hooks don&#x27;t support the &quot;</span> +</span><br><span class="line">          <span class="string">&quot;second callback argument. To execute a side effect after &quot;</span> +</span><br><span class="line">          <span class="string">&quot;rendering, declare it in the component body with useEffect().&quot;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> eventTime = <span class="title function_">requestEventTime</span>();</span><br><span class="line">  <span class="keyword">const</span> lane = <span class="title function_">requestUpdateLane</span>(fiber);</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">update</span>: <span class="title class_">Update</span>&lt;S, A&gt; = &#123;</span><br><span class="line">    lane,</span><br><span class="line">    action,</span><br><span class="line">    <span class="attr">eagerReducer</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">eagerState</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">next</span>: (<span class="attr">null</span>: any),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> alternate = fiber.<span class="property">alternate</span>;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    fiber === currentlyRenderingFiber ||</span><br><span class="line">    (alternate !== <span class="literal">null</span> &amp;&amp; alternate === currentlyRenderingFiber)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// This is a render phase update. Stash it in a lazily-created map of</span></span><br><span class="line">    <span class="comment">// queue -&gt; linked list of updates. After this render pass, we&#x27;ll restart</span></span><br><span class="line">    <span class="comment">// and apply the stashed updates on top of the work-in-progress hook.</span></span><br><span class="line">    didScheduleRenderPhaseUpdateDuringThisPass =</span><br><span class="line">      didScheduleRenderPhaseUpdate = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">const</span> pending = queue.<span class="property">pending</span>;</span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// This is the first update. Create a circular list.</span></span><br><span class="line">      update.<span class="property">next</span> = update;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.<span class="property">next</span> = pending.<span class="property">next</span>;</span><br><span class="line">      pending.<span class="property">next</span> = update;</span><br><span class="line">    &#125;</span><br><span class="line">    queue.<span class="property">pending</span> = update;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isInterleavedUpdate</span>(fiber, lane)) &#123;</span><br><span class="line">      <span class="keyword">const</span> interleaved = queue.<span class="property">interleaved</span>;</span><br><span class="line">      <span class="keyword">if</span> (interleaved === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// This is the first update. Create a circular list.</span></span><br><span class="line">        update.<span class="property">next</span> = update;</span><br><span class="line">        <span class="comment">// At the end of the current render, this queue&#x27;s interleaved updates will</span></span><br><span class="line">        <span class="comment">// be transferred to the pending queue.</span></span><br><span class="line">        <span class="title function_">pushInterleavedQueue</span>(queue);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        update.<span class="property">next</span> = interleaved.<span class="property">next</span>;</span><br><span class="line">        interleaved.<span class="property">next</span> = update;</span><br><span class="line">      &#125;</span><br><span class="line">      queue.<span class="property">interleaved</span> = update;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> pending = queue.<span class="property">pending</span>;</span><br><span class="line">      <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// This is the first update. Create a circular list.</span></span><br><span class="line">        update.<span class="property">next</span> = update;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        update.<span class="property">next</span> = pending.<span class="property">next</span>;</span><br><span class="line">        pending.<span class="property">next</span> = update;</span><br><span class="line">      &#125;</span><br><span class="line">      queue.<span class="property">pending</span> = update;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      fiber.<span class="property">lanes</span> === <span class="title class_">NoLanes</span> &amp;&amp;</span><br><span class="line">      (alternate === <span class="literal">null</span> || alternate.<span class="property">lanes</span> === <span class="title class_">NoLanes</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// The queue is currently empty, which means we can eagerly compute the</span></span><br><span class="line">      <span class="comment">// next state before entering the render phase. If the new state is the</span></span><br><span class="line">      <span class="comment">// same as the current state, we may be able to bail out entirely.</span></span><br><span class="line">      <span class="keyword">const</span> lastRenderedReducer = queue.<span class="property">lastRenderedReducer</span>;</span><br><span class="line">      <span class="keyword">if</span> (lastRenderedReducer !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> prevDispatcher;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          prevDispatcher = <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span>;</span><br><span class="line">          <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span> =</span><br><span class="line">            <span class="title class_">InvalidNestedHooksDispatcherOnUpdateInDEV</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> <span class="attr">currentState</span>: S = (queue.<span class="property">lastRenderedState</span>: any);</span><br><span class="line">          <span class="keyword">const</span> eagerState = <span class="title function_">lastRenderedReducer</span>(currentState, action);</span><br><span class="line">          <span class="comment">// Stash the eagerly computed state, and the reducer used to compute</span></span><br><span class="line">          <span class="comment">// it, on the update object. If the reducer hasn&#x27;t changed by the</span></span><br><span class="line">          <span class="comment">// time we enter the render phase, then the eager state can be used</span></span><br><span class="line">          <span class="comment">// without calling the reducer again.</span></span><br><span class="line">          update.<span class="property">eagerReducer</span> = lastRenderedReducer;</span><br><span class="line">          update.<span class="property">eagerState</span> = eagerState;</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">is</span>(eagerState, currentState)) &#123;</span><br><span class="line">            <span class="comment">// Fast path. We can bail out without scheduling React to re-render.</span></span><br><span class="line">            <span class="comment">// It&#x27;s still possible that we&#x27;ll need to rebase this update later,</span></span><br><span class="line">            <span class="comment">// if the component re-renders for a different reason and by that</span></span><br><span class="line">            <span class="comment">// time the reducer has changed.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">          <span class="comment">// Suppress the error. It will throw again in the render phase.</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span> = prevDispatcher;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="comment">// $FlowExpectedError - jest isn&#x27;t a global, and isn&#x27;t recognized outside of tests</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;undefined&quot;</span> !== <span class="keyword">typeof</span> jest) &#123;</span><br><span class="line">        <span class="title function_">warnIfNotCurrentlyActingUpdatesInDev</span>(fiber);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> root = <span class="title function_">scheduleUpdateOnFiber</span>(fiber, lane, eventTime);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isTransitionLane</span>(lane) &amp;&amp; root !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> queueLanes = queue.<span class="property">lanes</span>;</span><br><span class="line">      <span class="comment">// If any entangled lanes are no longer pending on the root, then they</span></span><br><span class="line">      <span class="comment">// must have finished. We can remove them from the shared queue, which</span></span><br><span class="line">      <span class="comment">// represents a superset of the actually pending lanes. In some cases we</span></span><br><span class="line">      <span class="comment">// may entangle more than we need to, but that&#x27;s OK. In fact it&#x27;s worse if</span></span><br><span class="line">      <span class="comment">// we *don&#x27;t* entangle when we should.</span></span><br><span class="line">      queueLanes = <span class="title function_">intersectLanes</span>(queueLanes, root.<span class="property">pendingLanes</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Entangle the new transition lane with the other transition lanes.</span></span><br><span class="line">      <span class="keyword">const</span> newQueueLanes = <span class="title function_">mergeLanes</span>(queueLanes, lane);</span><br><span class="line">      queue.<span class="property">lanes</span> = newQueueLanes;</span><br><span class="line">      <span class="comment">// Even if queue.lanes already include lane, we don&#x27;t know for certain if</span></span><br><span class="line">      <span class="comment">// the lane finished since the last time we entangled it. So we need to</span></span><br><span class="line">      <span class="comment">// entangle it again, just to be sure.</span></span><br><span class="line">      <span class="title function_">markRootEntangled</span>(root, newQueueLanes);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableDebugTracing) &#123;</span><br><span class="line">      <span class="keyword">if</span> (fiber.<span class="property">mode</span> &amp; <span class="title class_">DebugTracingMode</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> name = <span class="title function_">getComponentNameFromFiber</span>(fiber) || <span class="string">&quot;Unknown&quot;</span>;</span><br><span class="line">        <span class="title function_">logStateUpdateScheduled</span>(name, lane, action);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    <span class="title function_">markStateUpdateScheduled</span>(fiber, lane);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="requestEventTime-函数"><a href="#requestEventTime-函数" class="headerlink" title="requestEventTime 函数"></a>requestEventTime 函数</h3><ul>
<li>ReactFiberWorkLoop.old.js 中导出 requestEventTime 函数在里面会调用 now 函数。当前执行的上下文既不在 render 阶段也不在 commit 阶段返回当前当前时间戳，不然返回之前任务的时间戳。</li>
</ul>
<figure class="highlight js"><figcaption><span>requestEventTime</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">requestEventTime</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> ((executionContext &amp; (<span class="title class_">RenderContext</span> | <span class="title class_">CommitContext</span>)) !== <span class="title class_">NoContext</span>) &#123;</span><br><span class="line">    <span class="comment">// We&#x27;re inside React, so it&#x27;s fine to read the actual time.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">now</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// We&#x27;re not inside React, so we may be in the middle of a browser event.</span></span><br><span class="line">  <span class="keyword">if</span> (currentEventTime !== <span class="title class_">NoTimestamp</span>) &#123;</span><br><span class="line">    <span class="comment">// Use the same start time for all updates until we enter React again.</span></span><br><span class="line">    <span class="keyword">return</span> currentEventTime;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// This is the first update since React yielded. Compute a new start time.</span></span><br><span class="line">  currentEventTime = <span class="title function_">now</span>();</span><br><span class="line">  <span class="keyword">return</span> currentEventTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="now-函数"><a href="#now-函数" class="headerlink" title="now 函数"></a>now 函数</h3><ul>
<li>Scheduler 模块中的 Scheduler.js 中导出 now 函数,会首先判断 performance.now 浏览器是否兼容不然就调用 localDate.now。performance.now 是从页面 navigationstart 开始算精度为毫秒级一个时间差值。而 localDate.now 是返回自 1970 年 1 月 1 日 00:00:00 (UTC) 到当前时间的毫秒数。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hasPerformanceNow =</span><br><span class="line">  <span class="keyword">typeof</span> performance === <span class="string">&quot;object&quot;</span> &amp;&amp; <span class="keyword">typeof</span> performance.<span class="property">now</span> === <span class="string">&quot;function&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (hasPerformanceNow) &#123;</span><br><span class="line">  <span class="keyword">const</span> localPerformance = performance;</span><br><span class="line">  getCurrentTime = <span class="function">() =&gt;</span> localPerformance.<span class="title function_">now</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> localDate = <span class="title class_">Date</span>;</span><br><span class="line">  <span class="keyword">const</span> initialTime = localDate.<span class="title function_">now</span>();</span><br><span class="line">  getCurrentTime = <span class="function">() =&gt;</span> localDate.<span class="title function_">now</span>() - initialTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="requestUpdateLane-函数"><a href="#requestUpdateLane-函数" class="headerlink" title="requestUpdateLane 函数"></a>requestUpdateLane 函数</h3><ul>
<li>requestUpdateLane 获取当前 fiber 的 lane</li>
</ul>
<figure class="highlight js"><figcaption><span>ReactFiberWorkLoop.old.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">requestUpdateLane</span>(<span class="params">fiber: Fiber</span>): <span class="title class_">Lane</span> &#123;</span><br><span class="line">  <span class="comment">// Special cases</span></span><br><span class="line">  <span class="keyword">const</span> mode = fiber.<span class="property">mode</span>;</span><br><span class="line">  <span class="keyword">if</span> ((mode &amp; <span class="title class_">ConcurrentMode</span>) === <span class="title class_">NoMode</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="title class_">SyncLane</span>: <span class="title class_">Lane</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    !deferRenderPhaseUpdateToNextBatch &amp;&amp;</span><br><span class="line">    (executionContext &amp; <span class="title class_">RenderContext</span>) !== <span class="title class_">NoContext</span> &amp;&amp;</span><br><span class="line">    workInProgressRootRenderLanes !== <span class="title class_">NoLanes</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// This is a render phase update. These are not officially supported. The</span></span><br><span class="line">    <span class="comment">// old behavior is to give this the same &quot;thread&quot; (lanes) as</span></span><br><span class="line">    <span class="comment">// whatever is currently rendering. So if you call `setState` on a component</span></span><br><span class="line">    <span class="comment">// that happens later in the same render, it will flush. Ideally, we want to</span></span><br><span class="line">    <span class="comment">// remove the special case and treat them as if they came from an</span></span><br><span class="line">    <span class="comment">// interleaved event. Regardless, this pattern is not officially supported.</span></span><br><span class="line">    <span class="comment">// This behavior is only a fallback. The flag only exists until we can roll</span></span><br><span class="line">    <span class="comment">// out the setState warning, since existing code might accidentally rely on</span></span><br><span class="line">    <span class="comment">// the current behavior.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">pickArbitraryLane</span>(workInProgressRootRenderLanes);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> isTransition = <span class="title function_">requestCurrentTransition</span>() !== <span class="title class_">NoTransition</span>;</span><br><span class="line">  <span class="keyword">if</span> (isTransition) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">      warnOnSubscriptionInsideStartTransition &amp;&amp;</span><br><span class="line">      <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">_updatedFibers</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">_updatedFibers</span>.<span class="title function_">add</span>(fiber);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The algorithm for assigning an update to a lane should be stable for all</span></span><br><span class="line">    <span class="comment">// updates at the same priority within the same event. To do this, the</span></span><br><span class="line">    <span class="comment">// inputs to the algorithm must be the same.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The trick we use is to cache the first of each of these inputs within an</span></span><br><span class="line">    <span class="comment">// event. Then reset the cached values once we can be sure the event is</span></span><br><span class="line">    <span class="comment">// over. Our heuristic for that is whenever we enter a concurrent work loop.</span></span><br><span class="line">    <span class="keyword">if</span> (currentEventTransitionLane === <span class="title class_">NoLane</span>) &#123;</span><br><span class="line">      <span class="comment">// All transitions within the same event are assigned the same lane.</span></span><br><span class="line">      currentEventTransitionLane = <span class="title function_">claimNextTransitionLane</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> currentEventTransitionLane;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Updates originating inside certain React methods, like flushSync, have</span></span><br><span class="line">  <span class="comment">// their priority set by tracking it with a context variable.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// The opaque type returned by the host config is internally a lane, so we can</span></span><br><span class="line">  <span class="comment">// use that directly.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Move this type conversion to the event priority module.</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">updateLane</span>: <span class="title class_">Lane</span> = (<span class="title function_">getCurrentUpdatePriority</span>(): any);</span><br><span class="line">  <span class="keyword">if</span> (updateLane !== <span class="title class_">NoLane</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> updateLane;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// This update originated outside React. Ask the host environment for an</span></span><br><span class="line">  <span class="comment">// appropriate priority, based on the type of event.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// The opaque type returned by the host config is internally a lane, so we can</span></span><br><span class="line">  <span class="comment">// use that directly.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Move this type conversion to the event priority module.</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">eventLane</span>: <span class="title class_">Lane</span> = (<span class="title function_">getCurrentEventPriority</span>(): any);</span><br><span class="line">  <span class="keyword">return</span> eventLane;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="updateState-函数"><a href="#updateState-函数" class="headerlink" title="updateState 函数"></a>updateState 函数</h3><ul>
<li>updateState 函数调用 updateReducer 函数。</li>
</ul>
<figure class="highlight js"><figcaption><span>updateState</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> updateState&lt;S&gt;(</span><br><span class="line">  <span class="attr">initialState</span>: (<span class="function">() =&gt;</span> S) | S</span><br><span class="line">): [S, <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt;] &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">updateReducer</span>(basicStateReducer, (<span class="attr">initialState</span>: any));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="updateReducer-函数"><a href="#updateReducer-函数" class="headerlink" title="updateReducer 函数"></a>updateReducer 函数</h3><ul>
<li>updateReducer 函数则首先会调用 updateWorkInProgressHook 函数。之后判断经过 updateWorkInProgressHook 更新后的 queue 是否有任务，有的话将更新后的 hook.queue 加到当前的 currentHook.baseQueue 上。isSubsetOfLanes 函数判断 render 的 lane 是否包含 upadte 的 lane，如果包含则把 updateLane 加到正在渲染的 currentlyRenderingFiber 的 lane 上，markSkippedUpdateLanes 函数则会再把 updateLane 加到 workInProgressRootSkippedLanes 上，再就判断 reduer 获取 newState，并挂载到 upadte 的 action 上。并且是在 do while 循环中把 upate 的队列所有的 fiber 任务都处理完。判断 newState 和 hook.memoizedState 是否不等，不等的话调用 markWorkInProgressReceivedUpdate 函数更改变量 didReceiveUpdate&#x3D;true 表示已经更新，执行完循环给 hook.memoizedState 赋值 newState。由于在 mountReduce 阶段 queue.dispatch 挂载 dispatch 方法，所有 upadteReducer 阶段就直接拿到 hook.memoizedState 和 dispatch，并返回。</li>
</ul>
<figure class="highlight js"><figcaption><span>updateReducer</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> updateReducer&lt;S, I, A&gt;(</span><br><span class="line">  <span class="attr">reducer</span>: <span class="function">(<span class="params">S, A</span>) =&gt;</span> S,</span><br><span class="line">  <span class="attr">initialArg</span>: I,</span><br><span class="line">  init?: <span class="function">(<span class="params">I</span>) =&gt;</span> S</span><br><span class="line">): [S, <span class="title class_">Dispatch</span>&lt;A&gt;] &#123;</span><br><span class="line">  <span class="keyword">const</span> hook = <span class="title function_">updateWorkInProgressHook</span>();</span><br><span class="line">  <span class="keyword">const</span> queue = hook.<span class="property">queue</span>;</span><br><span class="line">  <span class="title function_">invariant</span>(</span><br><span class="line">    queue !== <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&quot;Should have a queue. This is likely a bug in React. Please file an issue.&quot;</span></span><br><span class="line">  );</span><br><span class="line">  queue.<span class="property">lastRenderedReducer</span> = reducer;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">current</span>: <span class="title class_">Hook</span> = (<span class="attr">currentHook</span>: any);</span><br><span class="line">  <span class="comment">// The last rebase update that is NOT part of the base state.</span></span><br><span class="line">  <span class="keyword">let</span> baseQueue = current.<span class="property">baseQueue</span>;</span><br><span class="line">  <span class="comment">// The last pending update that hasn&#x27;t been processed yet.</span></span><br><span class="line">  <span class="keyword">const</span> pendingQueue = queue.<span class="property">pending</span>;</span><br><span class="line">  <span class="keyword">if</span> (pendingQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// We have new updates that haven&#x27;t been processed yet.</span></span><br><span class="line">    <span class="comment">// We&#x27;ll add them to the base queue.</span></span><br><span class="line">    <span class="keyword">if</span> (baseQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Merge the pending queue and the base queue.</span></span><br><span class="line">      <span class="keyword">const</span> baseFirst = baseQueue.<span class="property">next</span>;</span><br><span class="line">      <span class="keyword">const</span> pendingFirst = pendingQueue.<span class="property">next</span>;</span><br><span class="line">      baseQueue.<span class="property">next</span> = pendingFirst;</span><br><span class="line">      pendingQueue.<span class="property">next</span> = baseFirst;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">if</span> (current.<span class="property">baseQueue</span> !== baseQueue) &#123;</span><br><span class="line">        <span class="comment">// Internal invariant that should never happen, but feasibly could in</span></span><br><span class="line">        <span class="comment">// the future if we implement resuming, or some form of that.</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(</span><br><span class="line">          <span class="string">&quot;Internal error: Expected work-in-progress queue to be a clone. &quot;</span> +</span><br><span class="line">            <span class="string">&quot;This is a bug in React.&quot;</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    current.<span class="property">baseQueue</span> = baseQueue = pendingQueue;</span><br><span class="line">    queue.<span class="property">pending</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (baseQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// We have a queue to process.</span></span><br><span class="line">    <span class="keyword">const</span> first = baseQueue.<span class="property">next</span>;</span><br><span class="line">    <span class="keyword">let</span> newState = current.<span class="property">baseState</span>;</span><br><span class="line">    <span class="keyword">let</span> newBaseState = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> newBaseQueueFirst = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> newBaseQueueLast = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> update = first;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> updateLane = update.<span class="property">lane</span>;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="title function_">isSubsetOfLanes</span>(renderLanes, updateLane)) &#123;</span><br><span class="line">        <span class="comment">// Priority is insufficient. Skip this update. If this is the first</span></span><br><span class="line">        <span class="comment">// skipped update, the previous update/state is the new base</span></span><br><span class="line">        <span class="comment">// update/state.</span></span><br><span class="line">        <span class="keyword">const</span> <span class="attr">clone</span>: <span class="title class_">Update</span>&lt;S, A&gt; = &#123;</span><br><span class="line">          <span class="attr">lane</span>: updateLane,</span><br><span class="line">          <span class="attr">action</span>: update.<span class="property">action</span>,</span><br><span class="line">          <span class="attr">eagerReducer</span>: update.<span class="property">eagerReducer</span>,</span><br><span class="line">          <span class="attr">eagerState</span>: update.<span class="property">eagerState</span>,</span><br><span class="line">          <span class="attr">next</span>: (<span class="attr">null</span>: any),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (newBaseQueueLast === <span class="literal">null</span>) &#123;</span><br><span class="line">          newBaseQueueFirst = newBaseQueueLast = clone;</span><br><span class="line">          newBaseState = newState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          newBaseQueueLast = newBaseQueueLast.<span class="property">next</span> = clone;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Update the remaining priority in the queue.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Don&#x27;t need to accumulate this. Instead, we can remove</span></span><br><span class="line">        <span class="comment">// renderLanes from the original lanes.</span></span><br><span class="line">        currentlyRenderingFiber.<span class="property">lanes</span> = <span class="title function_">mergeLanes</span>(</span><br><span class="line">          currentlyRenderingFiber.<span class="property">lanes</span>,</span><br><span class="line">          updateLane</span><br><span class="line">        );</span><br><span class="line">        <span class="title function_">markSkippedUpdateLanes</span>(updateLane);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This update does have sufficient priority.</span></span><br><span class="line">        <span class="keyword">if</span> (newBaseQueueLast !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> <span class="attr">clone</span>: <span class="title class_">Update</span>&lt;S, A&gt; = &#123;</span><br><span class="line">            <span class="comment">// This update is going to be committed so we never want uncommit</span></span><br><span class="line">            <span class="comment">// it. Using NoLane works because 0 is a subset of all bitmasks, so</span></span><br><span class="line">            <span class="comment">// this will never be skipped by the check above.</span></span><br><span class="line">            <span class="attr">lane</span>: <span class="title class_">NoLane</span>,</span><br><span class="line">            <span class="attr">action</span>: update.<span class="property">action</span>,</span><br><span class="line">            <span class="attr">eagerReducer</span>: update.<span class="property">eagerReducer</span>,</span><br><span class="line">            <span class="attr">eagerState</span>: update.<span class="property">eagerState</span>,</span><br><span class="line">            <span class="attr">next</span>: (<span class="attr">null</span>: any),</span><br><span class="line">          &#125;;</span><br><span class="line">          newBaseQueueLast = newBaseQueueLast.<span class="property">next</span> = clone;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Process this update.</span></span><br><span class="line">        <span class="keyword">if</span> (update.<span class="property">eagerReducer</span> === reducer) &#123;</span><br><span class="line">          <span class="comment">// If this update was processed eagerly, and its reducer matches the</span></span><br><span class="line">          <span class="comment">// current reducer, we can use the eagerly computed state.</span></span><br><span class="line">          newState = ((update.<span class="property">eagerState</span>: any): S);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> action = update.<span class="property">action</span>;</span><br><span class="line">          newState = <span class="title function_">reducer</span>(newState, action);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      update = update.<span class="property">next</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (update !== <span class="literal">null</span> &amp;&amp; update !== first);</span><br><span class="line">    <span class="keyword">if</span> (newBaseQueueLast === <span class="literal">null</span>) &#123;</span><br><span class="line">      newBaseState = newState;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      newBaseQueueLast.<span class="property">next</span> = (<span class="attr">newBaseQueueFirst</span>: any);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Mark that the fiber performed work, but only if the new state is</span></span><br><span class="line">    <span class="comment">// different from the current state.</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">is</span>(newState, hook.<span class="property">memoizedState</span>)) &#123;</span><br><span class="line">      <span class="title function_">markWorkInProgressReceivedUpdate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    hook.<span class="property">memoizedState</span> = newState;</span><br><span class="line">    hook.<span class="property">baseState</span> = newBaseState;</span><br><span class="line">    hook.<span class="property">baseQueue</span> = newBaseQueueLast;</span><br><span class="line">    queue.<span class="property">lastRenderedState</span> = newState;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Interleaved updates are stored on a separate queue. We aren&#x27;t going to</span></span><br><span class="line">  <span class="comment">// process them during this render, but we do need to track which lanes</span></span><br><span class="line">  <span class="comment">// are remaining.</span></span><br><span class="line">  <span class="keyword">const</span> lastInterleaved = queue.<span class="property">interleaved</span>;</span><br><span class="line">  <span class="keyword">if</span> (lastInterleaved !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> interleaved = lastInterleaved;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> interleavedLane = interleaved.<span class="property">lane</span>;</span><br><span class="line">      currentlyRenderingFiber.<span class="property">lanes</span> = <span class="title function_">mergeLanes</span>(</span><br><span class="line">        currentlyRenderingFiber.<span class="property">lanes</span>,</span><br><span class="line">        interleavedLane</span><br><span class="line">      );</span><br><span class="line">      <span class="title function_">markSkippedUpdateLanes</span>(interleavedLane);</span><br><span class="line">      interleaved = ((<span class="attr">interleaved</span>: any).<span class="property">next</span>: <span class="title class_">Update</span>&lt;S, A&gt;);</span><br><span class="line">    &#125; <span class="keyword">while</span> (interleaved !== lastInterleaved);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (baseQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// `queue.lanes` is used for entangling transitions. We can set it back to</span></span><br><span class="line">    <span class="comment">// zero once the queue is empty.</span></span><br><span class="line">    queue.<span class="property">lanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">dispatch</span>: <span class="title class_">Dispatch</span>&lt;A&gt; = (queue.<span class="property">dispatch</span>: any);</span><br><span class="line">  <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="updateWorkInProgressHook-函数"><a href="#updateWorkInProgressHook-函数" class="headerlink" title="updateWorkInProgressHook 函数"></a>updateWorkInProgressHook 函数</h3><ul>
<li>updateWorkInProgressHook 函数主要判断当前 currentHook 或 workInProgressHook 有没有值有的话就取当前的 hook 的 next 赋值给 workInProgressHook,没有的话就取当前 rendering 阶段的 fiber 取缓存的 memoizedState,在 mountWorkInProgressHook 阶段可以看到 memoizedState 存的就是 hook,所以 updateWorkInProgressHook 函数主要就是取下一个 hook。</li>
</ul>
<figure class="highlight js"><figcaption><span>updateWorkInProgressHook</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateWorkInProgressHook</span>(<span class="params"></span>): <span class="title class_">Hook</span> &#123;</span><br><span class="line">  <span class="comment">// This function is used both for updates and for re-renders triggered by a</span></span><br><span class="line">  <span class="comment">// render phase update. It assumes there is either a current hook we can</span></span><br><span class="line">  <span class="comment">// clone, or a work-in-progress hook from a previous render pass that we can</span></span><br><span class="line">  <span class="comment">// use as a base. When we reach the end of the base list, we must switch to</span></span><br><span class="line">  <span class="comment">// the dispatcher used for mounts.</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">nextCurrentHook</span>: <span class="literal">null</span> | <span class="title class_">Hook</span>;</span><br><span class="line">  <span class="keyword">if</span> (currentHook === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> current = currentlyRenderingFiber.<span class="property">alternate</span>;</span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      nextCurrentHook = current.<span class="property">memoizedState</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nextCurrentHook = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nextCurrentHook = currentHook.<span class="property">next</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">nextWorkInProgressHook</span>: <span class="literal">null</span> | <span class="title class_">Hook</span>;</span><br><span class="line">  <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">    nextWorkInProgressHook = currentlyRenderingFiber.<span class="property">memoizedState</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nextWorkInProgressHook = workInProgressHook.<span class="property">next</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (nextWorkInProgressHook !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// There&#x27;s already a work-in-progress. Reuse it.</span></span><br><span class="line">    workInProgressHook = nextWorkInProgressHook;</span><br><span class="line">    nextWorkInProgressHook = workInProgressHook.<span class="property">next</span>;</span><br><span class="line">    currentHook = nextCurrentHook;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Clone from the current hook.</span></span><br><span class="line">    <span class="title function_">invariant</span>(</span><br><span class="line">      nextCurrentHook !== <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;Rendered more hooks than during the previous render.&quot;</span></span><br><span class="line">    );</span><br><span class="line">    currentHook = nextCurrentHook;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">newHook</span>: <span class="title class_">Hook</span> = &#123;</span><br><span class="line">      <span class="attr">memoizedState</span>: currentHook.<span class="property">memoizedState</span>,</span><br><span class="line">      <span class="attr">baseState</span>: currentHook.<span class="property">baseState</span>,</span><br><span class="line">      <span class="attr">baseQueue</span>: currentHook.<span class="property">baseQueue</span>,</span><br><span class="line">      <span class="attr">queue</span>: currentHook.<span class="property">queue</span>,</span><br><span class="line">      <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// This is the first hook in the list.</span></span><br><span class="line">      currentlyRenderingFiber.<span class="property">memoizedState</span> = workInProgressHook = newHook;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Append to the end of the list.</span></span><br><span class="line">      workInProgressHook = workInProgressHook.<span class="property">next</span> = newHook;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="isSubsetOfLanes-函数"><a href="#isSubsetOfLanes-函数" class="headerlink" title="isSubsetOfLanes 函数"></a>isSubsetOfLanes 函数</h3><ul>
<li>isSubsetOfLanes 函数判断 set 的 lane 是否包含 subset 的 lane。</li>
</ul>
<figure class="highlight js"><figcaption><span>isSubsetOfLanes</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isSubsetOfLanes</span>(<span class="params">set: Lanes, subset: Lanes | Lane</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (set &amp; subset) === subset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="mergeLanes-函数"><a href="#mergeLanes-函数" class="headerlink" title="mergeLanes 函数"></a>mergeLanes 函数</h3><ul>
<li>mergeLanes 把 b 加到 a 的 lane 上。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mergeLanes</span>(<span class="params">a: Lanes | Lane, b: Lanes | Lane</span>): <span class="title class_">Lanes</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a | b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="markSkippedUpdateLanes-函数"><a href="#markSkippedUpdateLanes-函数" class="headerlink" title="markSkippedUpdateLanes 函数"></a>markSkippedUpdateLanes 函数</h3><ul>
<li>markSkippedUpdateLanes 把传入的 lane 加到 workInProgressRootSkippedLanes 上。</li>
</ul>
<figure class="highlight js"><figcaption><span>markSkippedUpdateLanes</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">markSkippedUpdateLanes</span>(<span class="params">lane: Lane | Lanes</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  workInProgressRootSkippedLanes = <span class="title function_">mergeLanes</span>(</span><br><span class="line">    lane,</span><br><span class="line">    workInProgressRootSkippedLanes</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="basicStateReducer-函数"><a href="#basicStateReducer-函数" class="headerlink" title="basicStateReducer 函数"></a>basicStateReducer 函数</h3><ul>
<li>basicStateReducer 函数</li>
</ul>
<figure class="highlight js"><figcaption><span>basicStateReducer</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> basicStateReducer&lt;S&gt;(<span class="attr">state</span>: S, <span class="attr">action</span>: <span class="title class_">BasicStateAction</span>&lt;S&gt;): S &#123;</span><br><span class="line">  <span class="comment">// $FlowFixMe: Flow doesn&#x27;t like mixed types</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> action === <span class="string">&quot;function&quot;</span> ? <span class="title function_">action</span>(state) : action;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="is-函数"><a href="#is-函数" class="headerlink" title="is 函数"></a>is 函数</h3><ul>
<li>is 函数判断两个值是否相等 shared&#x2F;objectIs.js</li>
</ul>
<figure class="highlight js"><figcaption><span>objectIs.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">is</span>(<span class="params">x: any, y: any</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    (x === y &amp;&amp; (x !== <span class="number">0</span> || <span class="number">1</span> / x === <span class="number">1</span> / y)) || (x !== x &amp;&amp; y !== y) <span class="comment">// eslint-disable-line no-self-compare</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">objectIs</span>: <span class="function">(<span class="params">x: any, y: any</span>) =&gt;</span> boolean =</span><br><span class="line">  <span class="keyword">typeof</span> <span class="title class_">Object</span>.<span class="property">is</span> === <span class="string">&quot;function&quot;</span> ? <span class="title class_">Object</span>.<span class="property">is</span> : is;</span><br></pre></td></tr></table></figure>

<h3 id="markWorkInProgressReceivedUpdate-函数"><a href="#markWorkInProgressReceivedUpdate-函数" class="headerlink" title="markWorkInProgressReceivedUpdate 函数"></a>markWorkInProgressReceivedUpdate 函数</h3><figure class="highlight js"><figcaption><span>markWorkInProgressReceivedUpdate</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">markWorkInProgressReceivedUpdate</span>(<span class="params"></span>) &#123;</span><br><span class="line">  didReceiveUpdate = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rerenderState-函数调用-rerenderReducer-函数。"><a href="#rerenderState-函数调用-rerenderReducer-函数。" class="headerlink" title="rerenderState 函数调用 rerenderReducer 函数。"></a>rerenderState 函数调用 rerenderReducer 函数。</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> rerenderState&lt;S&gt;(</span><br><span class="line">  <span class="attr">initialState</span>: (<span class="function">() =&gt;</span> S) | S</span><br><span class="line">): [S, <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt;] &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">rerenderReducer</span>(basicStateReducer, (<span class="attr">initialState</span>: any));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rerenderReducer-函数，也会调用-updateWorkInProgressHook-函数获取最新的-hook，然后-while-循环获取最新的-newState。"><a href="#rerenderReducer-函数，也会调用-updateWorkInProgressHook-函数获取最新的-hook，然后-while-循环获取最新的-newState。" class="headerlink" title="rerenderReducer 函数，也会调用 updateWorkInProgressHook 函数获取最新的 hook，然后 while 循环获取最新的 newState。"></a>rerenderReducer 函数，也会调用 updateWorkInProgressHook 函数获取最新的 hook，然后 while 循环获取最新的 newState。</h3><figure class="highlight js"><figcaption><span>rerenderReducer</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> rerenderReducer&lt;S, I, A&gt;(</span><br><span class="line">  <span class="attr">reducer</span>: <span class="function">(<span class="params">S, A</span>) =&gt;</span> S,</span><br><span class="line">  <span class="attr">initialArg</span>: I,</span><br><span class="line">  init?: <span class="function">(<span class="params">I</span>) =&gt;</span> S</span><br><span class="line">): [S, <span class="title class_">Dispatch</span>&lt;A&gt;] &#123;</span><br><span class="line">  <span class="keyword">const</span> hook = <span class="title function_">updateWorkInProgressHook</span>();</span><br><span class="line">  <span class="keyword">const</span> queue = hook.<span class="property">queue</span>;</span><br><span class="line">  <span class="title function_">invariant</span>(</span><br><span class="line">    queue !== <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&quot;Should have a queue. This is likely a bug in React. Please file an issue.&quot;</span></span><br><span class="line">  );</span><br><span class="line">  queue.<span class="property">lastRenderedReducer</span> = reducer;</span><br><span class="line">  <span class="comment">// This is a re-render. Apply the new render phase updates to the previous</span></span><br><span class="line">  <span class="comment">// work-in-progress hook.</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">dispatch</span>: <span class="title class_">Dispatch</span>&lt;A&gt; = (queue.<span class="property">dispatch</span>: any);</span><br><span class="line">  <span class="keyword">const</span> lastRenderPhaseUpdate = queue.<span class="property">pending</span>;</span><br><span class="line">  <span class="keyword">let</span> newState = hook.<span class="property">memoizedState</span>;</span><br><span class="line">  <span class="keyword">if</span> (lastRenderPhaseUpdate !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// The queue doesn&#x27;t persist past this render pass.</span></span><br><span class="line">    queue.<span class="property">pending</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> firstRenderPhaseUpdate = lastRenderPhaseUpdate.<span class="property">next</span>;</span><br><span class="line">    <span class="keyword">let</span> update = firstRenderPhaseUpdate;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="comment">// Process this render phase update. We don&#x27;t have to check the</span></span><br><span class="line">      <span class="comment">// priority because it will always be the same as the current</span></span><br><span class="line">      <span class="comment">// render&#x27;s.</span></span><br><span class="line">      <span class="keyword">const</span> action = update.<span class="property">action</span>;</span><br><span class="line">      newState = <span class="title function_">reducer</span>(newState, action);</span><br><span class="line">      update = update.<span class="property">next</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (update !== firstRenderPhaseUpdate);</span><br><span class="line">    <span class="comment">// Mark that the fiber performed work, but only if the new state is</span></span><br><span class="line">    <span class="comment">// different from the current state.</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">is</span>(newState, hook.<span class="property">memoizedState</span>)) &#123;</span><br><span class="line">      <span class="title function_">markWorkInProgressReceivedUpdate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    hook.<span class="property">memoizedState</span> = newState;</span><br><span class="line">    <span class="comment">// Don&#x27;t persist the state accumulated from the render phase updates to</span></span><br><span class="line">    <span class="comment">// the base state unless the queue is empty.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Not sure if this is the desired semantics, but it&#x27;s what we</span></span><br><span class="line">    <span class="comment">// do for gDSFP. I can&#x27;t remember why.</span></span><br><span class="line">    <span class="keyword">if</span> (hook.<span class="property">baseQueue</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">      hook.<span class="property">baseState</span> = newState;</span><br><span class="line">    &#125;</span><br><span class="line">    queue.<span class="property">lastRenderedState</span> = newState;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> [newState, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Hook-Update-UpdateQueue-的数据结构。"><a href="#Hook-Update-UpdateQueue-的数据结构。" class="headerlink" title="Hook,Update,UpdateQueue 的数据结构。"></a>Hook,Update,UpdateQueue 的数据结构。</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">type <span class="title class_">Hook</span> = &#123;|</span><br><span class="line">  <span class="attr">memoizedState</span>: any,</span><br><span class="line">  <span class="attr">baseState</span>: any,</span><br><span class="line">  <span class="attr">baseQueue</span>: <span class="title class_">Update</span>&lt;any, any&gt; | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">queue</span>: any,</span><br><span class="line">  <span class="attr">next</span>: <span class="title class_">Hook</span> | <span class="literal">null</span>,</span><br><span class="line">|&#125;;</span><br><span class="line"></span><br><span class="line">type <span class="title class_">Update</span>&lt;S, A&gt; = &#123;|</span><br><span class="line">  <span class="attr">lane</span>: <span class="title class_">Lane</span>,</span><br><span class="line">  <span class="attr">action</span>: A,</span><br><span class="line">  <span class="attr">eagerReducer</span>: (<span class="function">(<span class="params">S, A</span>) =&gt;</span> S) | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">eagerState</span>: S | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">next</span>: <span class="title class_">Update</span>&lt;S, A&gt;,</span><br><span class="line">|&#125;;</span><br><span class="line"></span><br><span class="line">type <span class="title class_">UpdateQueue</span>&lt;S, A&gt; = &#123;|</span><br><span class="line">  <span class="attr">pending</span>: <span class="title class_">Update</span>&lt;S, A&gt; | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">interleaved</span>: <span class="title class_">Update</span>&lt;S, A&gt; | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">lanes</span>: <span class="title class_">Lanes</span>,</span><br><span class="line">  <span class="attr">dispatch</span>: (<span class="function">(<span class="params">A</span>) =&gt;</span> mixed) | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">lastRenderedReducer</span>: (<span class="function">(<span class="params">S, A</span>) =&gt;</span> S) | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">lastRenderedState</span>: S | <span class="literal">null</span>,</span><br><span class="line">|&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>useState 过程中的 Hook,Update,UpdateQueue 的数据结构<br><img src="../img/hook.webp" alt="avatar"></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://yangliang19950819.github.io/blog">囧</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://yangliang19950819.github.io/blog/reactSource/">https://yangliang19950819.github.io/blog/reactSource/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yangliang19950819.github.io/blog" target="_blank">有个网站</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="../img/react-s.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="../css-module/" title="css-loader怎么实现css-module"><img class="cover" src="../img/css-module.webp" onerror="onerror=null;src='../img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">css-loader怎么实现css-module</div></div></a></div><div class="next-post pull-right"><a href="../oneLinerJsSkill/" title="20个一行js的小技巧"><img class="cover" src="../img/oneLiner.webp" onerror="onerror=null;src='../img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">20个一行js的小技巧</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="../img/avatar.jpeg" onerror="this.onerror=null;this.src='../img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">囧</div><div class="author-info__description">囧的博客</div></div><div class="card-info-data site-data is-center"><a href="../archives/"><div class="headline">文章</div><div class="length-num">17</div></a><a href="/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="../categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#react-ReactHook-js-useState-%E5%87%BD%E6%95%B0"><span class="toc-number">1.</span> <span class="toc-text">react&#x2F;ReactHook.js useState 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReactFiberHooks-old-js-%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E9%98%B6%E6%AE%B5%E5%AF%B9%E5%BA%94%E7%9A%84-ReactCurrentDispatcher-current-%E5%80%BC%E4%B8%8D%E4%B8%80%E6%A0%B7"><span class="toc-number">2.</span> <span class="toc-text">ReactFiberHooks.old.js 在不同的阶段对应的 ReactCurrentDispatcher.current 值不一样</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mountState-%E5%87%BD%E6%95%B0"><span class="toc-number">3.</span> <span class="toc-text">mountState 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mountWorkInProgressHook-%E5%87%BD%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">mountWorkInProgressHook 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dispatchAction-%E5%87%BD%E6%95%B0"><span class="toc-number">5.</span> <span class="toc-text">dispatchAction 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#requestEventTime-%E5%87%BD%E6%95%B0"><span class="toc-number">6.</span> <span class="toc-text">requestEventTime 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#now-%E5%87%BD%E6%95%B0"><span class="toc-number">7.</span> <span class="toc-text">now 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#requestUpdateLane-%E5%87%BD%E6%95%B0"><span class="toc-number">8.</span> <span class="toc-text">requestUpdateLane 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#updateState-%E5%87%BD%E6%95%B0"><span class="toc-number">9.</span> <span class="toc-text">updateState 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#updateReducer-%E5%87%BD%E6%95%B0"><span class="toc-number">10.</span> <span class="toc-text">updateReducer 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#updateWorkInProgressHook-%E5%87%BD%E6%95%B0"><span class="toc-number">11.</span> <span class="toc-text">updateWorkInProgressHook 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#isSubsetOfLanes-%E5%87%BD%E6%95%B0"><span class="toc-number">12.</span> <span class="toc-text">isSubsetOfLanes 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mergeLanes-%E5%87%BD%E6%95%B0"><span class="toc-number">13.</span> <span class="toc-text">mergeLanes 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#markSkippedUpdateLanes-%E5%87%BD%E6%95%B0"><span class="toc-number">14.</span> <span class="toc-text">markSkippedUpdateLanes 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#basicStateReducer-%E5%87%BD%E6%95%B0"><span class="toc-number">15.</span> <span class="toc-text">basicStateReducer 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#is-%E5%87%BD%E6%95%B0"><span class="toc-number">16.</span> <span class="toc-text">is 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#markWorkInProgressReceivedUpdate-%E5%87%BD%E6%95%B0"><span class="toc-number">17.</span> <span class="toc-text">markWorkInProgressReceivedUpdate 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rerenderState-%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8-rerenderReducer-%E5%87%BD%E6%95%B0%E3%80%82"><span class="toc-number">18.</span> <span class="toc-text">rerenderState 函数调用 rerenderReducer 函数。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rerenderReducer-%E5%87%BD%E6%95%B0%EF%BC%8C%E4%B9%9F%E4%BC%9A%E8%B0%83%E7%94%A8-updateWorkInProgressHook-%E5%87%BD%E6%95%B0%E8%8E%B7%E5%8F%96%E6%9C%80%E6%96%B0%E7%9A%84-hook%EF%BC%8C%E7%84%B6%E5%90%8E-while-%E5%BE%AA%E7%8E%AF%E8%8E%B7%E5%8F%96%E6%9C%80%E6%96%B0%E7%9A%84-newState%E3%80%82"><span class="toc-number">19.</span> <span class="toc-text">rerenderReducer 函数，也会调用 updateWorkInProgressHook 函数获取最新的 hook，然后 while 循环获取最新的 newState。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hook-Update-UpdateQueue-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%82"><span class="toc-number">20.</span> <span class="toc-text">Hook,Update,UpdateQueue 的数据结构。</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="../yapi/" title="基于yapi-to-typescript根据yapi接口文档自动.d.ts文件"><img src="../img/yapi.png" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="基于yapi-to-typescript根据yapi接口文档自动.d.ts文件"/></a><div class="content"><a class="title" href="../yapi/" title="基于yapi-to-typescript根据yapi接口文档自动.d.ts文件">基于yapi-to-typescript根据yapi接口文档自动.d.ts文件</a><time datetime="2024-09-03T02:58:57.486Z" title="发表于 2024-09-03 10:58:57">2024-09-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="../strapi/" title="如何在gatsby项目中本地运行时不请求strapi来提示项目启动速度"><img src="../img/strapi.png" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="如何在gatsby项目中本地运行时不请求strapi来提示项目启动速度"/></a><div class="content"><a class="title" href="../strapi/" title="如何在gatsby项目中本地运行时不请求strapi来提示项目启动速度">如何在gatsby项目中本地运行时不请求strapi来提示项目启动速度</a><time datetime="2024-09-03T02:33:51.496Z" title="发表于 2024-09-03 10:33:51">2024-09-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="../i18n/" title="基于react实现i18n以及如何支持i18n-ally"><img src="../img/shoe.jpg" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="基于react实现i18n以及如何支持i18n-ally"/></a><div class="content"><a class="title" href="../i18n/" title="基于react实现i18n以及如何支持i18n-ally">基于react实现i18n以及如何支持i18n-ally</a><time datetime="2024-09-03T01:53:40.928Z" title="发表于 2024-09-03 09:53:40">2024-09-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="../ts-skills/" title="ts utils"><img src="../img/useState.webp" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="ts utils"/></a><div class="content"><a class="title" href="../ts-skills/" title="ts utils">ts utils</a><time datetime="2021-11-09T01:54:59.337Z" title="发表于 2021-11-09 09:54:59">2021-11-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="../css-module/" title="css-loader怎么实现css-module"><img src="../img/css-module.webp" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="css-loader怎么实现css-module"/></a><div class="content"><a class="title" href="../css-module/" title="css-loader怎么实现css-module">css-loader怎么实现css-module</a><time datetime="2021-10-12T02:47:36.260Z" title="发表于 2021-10-12 10:47:36">2021-10-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 囧</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="../js/utils.js?v=4.13.0"></script><script src="../js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>